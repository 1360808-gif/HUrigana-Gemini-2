<script>
    // 【絶対に許さない修正リスト】
    const extremeFixes = [
        { wrong: /うらせつ/g, correct: 'うらぎ' },
        { wrong: /じしゅねり/g, correct: 'じしゅれん' },
        { wrong: /まと/g, correct: 'てき' },
        { wrong: /ぜっ～め/g, correct: 'ぜつめい' }
    ];

    // ... (中略：既存のgetReading関数など) ...

    async function processText() {
        const text = input.value;
        if (!text.trim()) { output.innerHTML = ""; return; }

        const segments = Array.from(segmenter.segment(text));
        let htmlResult = "";
        
        // ... (中略：プログレスバー表示など) ...

        for (let k = 0; k < segments.length; k++) {
            let word = segments[k].segment;
            
            if (/[\u4E00-\u9FFF\d]/.test(word)) {
                let reading = await getReading(word);
                
                // --- ここが「力づく」のフィルター ---
                extremeFixes.forEach(f => {
                    reading = reading.replace(f.wrong, f.correct);
                });

                // 裏切の漢字が含まれている場合の個別ガード
                if (word.includes('裏切')) {
                    reading = reading.replace(/りせつ|うらせつ/g, 'うらぎ');
                }
                if (word.includes('自主練')) {
                    reading = 'じしゅれん';
                }

                // 送り仮名分離ロジック
                let i = word.length - 1;
                let j = reading.length - 1;
                while (i >= 0 && j >= 0 && word[i] === reading[j] && !/[\u4E00-\u9FFF]/.test(word[i])) { i--; j--; }
                
                let kanjiPart = word.substring(0, i + 1);
                const okuriganaPart = word.substring(i + 1);
                let kanjiReading = reading.substring(0, j + 1);

                // 単発漢字の補正
                if (kanjiPart.length === 1 && verbFixes[kanjiPart]) { kanjiReading = verbFixes[kanjiPart]; }
                
                if (kanjiPart) { htmlResult += `<ruby>${kanjiPart}<rt contenteditable="true">${kanjiReading}</rt></ruby>${okuriganaPart}`; }
                else { htmlResult += word; }
            } else {
                htmlResult += word;
            }
            progressBar.value = k + 1;
        }
        // ... (以下略) ...
