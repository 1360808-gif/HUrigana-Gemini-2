<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãµã‚ŠãŒãªãƒã‚¸ãƒƒã‚¯ï¼</title>
    <script src="https://unpkg.com/wanakana"></script>
    <style>
        body {
            font-family: "UD Digi Kyokasho N-R", "UD ãƒ‡ã‚¸ã‚¿ãƒ« æ•™ç§‘æ›¸ä½“ N-R", "UD Digi Kyokasho NK-R", "UD ãƒ‡ã‚¸ã‚¿ãƒ« æ•™ç§‘æ›¸ä½“ NK-R", "Hiragino Sans", "Meiryo", sans-serif;
            background-color: #fcfcfc;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            color: #333;
        }

        header {
            flex: 1;
            display: flex;
            padding: 15px 20px;
            gap: 20px;
            background-color: #eef9ff;
            border-bottom: 2px solid #a6dcef;
            box-sizing: border-box;
        }

        .info-pane { flex: 1; display: flex; flex-direction: column; justify-content: center; }
        h1 { color: #1a73e8; margin: 0 0 8px 0; font-size: 1.5rem; }
        .notice { background: white; padding: 10px; border-radius: 10px; border: 2px solid #ffcc00; font-size: 0.85rem; line-height: 1.6; }

        .input-pane { flex: 1; display: flex; }
        textarea { width: 100%; height: 100%; border: 2px solid #a6dcef; border-radius: 12px; padding: 12px; font-family: inherit; font-size: 16px; resize: none; box-sizing: border-box; outline: none; }

        main { flex: 2; padding: 20px 40px; overflow-y: auto; background: white; box-sizing: border-box; position: relative; }
        #output { font-size: 24px; line-height: 2.4; word-break: break-all; }
        rt { color: #d9534f; font-size: 0.5em; font-weight: bold; cursor: pointer; padding: 0 2px; }
        rt:hover { background: #ffebeb; border-radius: 3px; }

        .tools { position: fixed; bottom: 15px; right: 20px; display: flex; gap: 10px; }
        .btn { background: #ff9f43; color: white; border: none; padding: 10px 20px; border-radius: 50px; font-family: inherit; font-weight: bold; cursor: pointer; box-shadow: 0 3px 0 #e67e22; font-size: 0.9rem; }
        .btn:active { transform: translateY(2px); box-shadow: none; }
        .btn.copy { background: #1a73e8; box-shadow: 0 3px 0 #0d47a1; }

        #status { position: absolute; top: 5px; right: 20px; font-size: 12px; color: #1a73e8; }
    </style>
</head>
<body>

    <header>
        <div class="info-pane">
            <h1>âœ¨ ãµã‚ŠãŒãªãƒã‚¸ãƒƒã‚¯</h1>
            <div class="notice">
                âš ï¸ <strong>ã¡ã‚…ã†ã„ï¼š</strong><br>
                ã¤ã‘ã‚‰ã‚ŒãŸ ãµã‚ŠãŒãªã¯ã€ã¾ã¡ãŒã£ã¦ã„ã‚‹ ã¨ããŒ ã‚ã‚Šã¾ã™ã€‚ãŠã‹ã—ã„ãªã¨ ãŠã‚‚ã£ãŸã‚‰ã€ã›ã‚“ã›ã„ã‚„ ã¨ã‚‚ã ã¡ã« ãã„ã¦ ã¿ã¦ã­ã€‚<br>
                ğŸ’¡ <strong>ãƒ’ãƒ³ãƒˆï¼š</strong><br>
                ã¾ã¡ãŒã£ã¦ã„ã‚‹ ãµã‚ŠãŒãªã¯ã€ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ ã˜ã¶ã‚“ã§ ãªãŠã™ã“ã¨ã‚‚ ã§ãã‚‹ã‚ˆï¼
            </div>
        </div>
        <div class="input-pane">
            <textarea id="input" placeholder="ã“ã“ã«ã€ãµã‚ŠãŒãªã‚’ ã¤ã‘ãŸã„ ã“ã¨ã°ã‚’ ã¯ã‚Šã¤ã‘ã¦ã­ï¼"></textarea>
        </div>
    </header>

    <main>
        <div id="status"></div>
        <div id="output"></div>
    </main>

    <div class="tools">
        <button class="btn copy" onclick="copyOutput()">ğŸ“‹ ãµã‚ŠãŒãªã¤ãã§ ã‚³ãƒ”ãƒ¼</button>
        <button class="btn" onclick="clearAll()">ğŸ”„ ãœã‚“ã¶ã‘ã™</button>
    </div>

    <script>
        const input = document.getElementById('input');
        const output = document.getElementById('output');
        const status = document.getElementById('status');
        let timer;

        // ç‰¹æ®Šãªèª­ã¿ã®è¾æ›¸ï¼ˆã˜ã—ã‚‡ï¼‰
        const customDict = {
            "å¤§ãƒ–ãƒ¼ãƒ ": "ã ã„ã¶ãƒ¼ã‚€",
            "çˆ†ç™ºçš„": "ã°ãã¯ã¤ã¦ã",
            "ç©ã¿é‡ãªã‚Š": "ã¤ã¿ã‹ã•ãªã‚Š",
            "2äºº": "ãµãŸã‚Š",
            "1äºº": "ã²ã¨ã‚Š"
        };

        const romajiMap = { 'Ä': 'aa', 'Ä«': 'ii', 'Å«': 'uu', 'Ä“': 'ei', 'Å': 'ou' };

        input.addEventListener('input', () => {
            clearTimeout(timer);
            status.innerText = "ã¾ã»ã†ã‚’ ã‹ã‘ã¦ã„ã¾ã™...";
            timer = setTimeout(processText, 600);
        });

        async function processText() {
            const text = input.value;
            if (!text.trim()) { output.innerHTML = ""; status.innerText = ""; return; }

            // æ–‡ã®åˆ‡ã‚Šæ–¹ã‚’å·¥å¤«ï¼ˆæ•°å­—ã¨æ¼¢å­—ã®ã‚»ãƒƒãƒˆãªã©ã‚’å„ªå…ˆï¼‰
            const regex = /(?:\d+[äººå¹´]|å¤§ãƒ–ãƒ¼ãƒ |çˆ†ç™ºçš„|ç©ã¿é‡ãªã‚Š|[\u4E00-\u9FFF]+)/g;
            let lastIdx = 0;
            let htmlResult = "";
            let match;

            while ((match = regex.exec(text)) !== null) {
                // ãƒãƒƒãƒã—ãªã‹ã£ãŸé–“ã®æ–‡å­—ï¼ˆã²ã‚‰ãŒãªç­‰ï¼‰ã‚’è¿½åŠ 
                htmlResult += text.substring(lastIdx, match.index);
                
                const word = match[0];
                let reading = "";

                // 1. è‡ªä½œè¾æ›¸ã«ã‚ã‚‹ã‹ç¢ºèª
                if (customDict[word]) {
                    reading = customDict[word];
                } else {
                    // 2. ãªã‘ã‚Œã°APIã«èã
                    reading = await getReading(word);
                }

                htmlResult += `<ruby>${word}<rt contenteditable="true">${reading}</rt></ruby>`;
                lastIdx = regex.lastIndex;
            }
            htmlResult += text.substring(lastIdx);
            
            output.innerHTML = htmlResult;
            status.innerText = "âœ… ã§ããŸã‚ˆï¼";
        }

        async function getReading(word) {
            try {
                const url = `https://translate.googleapis.com/translate_a/single?client=gtx&sl=ja&tl=ja&dt=rm&q=${encodeURIComponent(word)}`;
                const response = await fetch(url);
                const data = await response.json();
                let romaji = (data[0] && data[0][0] && data[0][0][3]) ? data[0][0][3] : "";
                
                let fixed = romaji.toLowerCase();
                Object.keys(romajiMap).forEach(key => { fixed = fixed.split(key).join(romajiMap[key]); });
                let hira = wanakana.toHiragana(fixed);
                
                // ã€Œå¤§ã€å˜ä½“ã§ã€Œã ã„ã€ã«ã—ãŸã„å ´åˆã®è£œæ­£
                if (word === "å¤§") return "ã ã„";
                
                return hira;
            } catch { return ""; }
        }

        function copyOutput() {
            const selection = window.getSelection();
            const range = document.createRange();
            range.selectNodeContents(output);
            selection.removeAllRanges();
            selection.addRange(range);
            document.execCommand('copy');
            selection.removeAllRanges();
            alert("ã‚³ãƒ”ãƒ¼ã—ãŸã‚ˆï¼");
        }

        function clearAll() {
            input.value = "";
            output.innerHTML = "";
            status.innerText = "";
            input.focus();
        }
    </script>
</body>
</html>
